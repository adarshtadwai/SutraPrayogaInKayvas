# Enhancement Script Documentation

## Overview

This document describes the enhancement process that adds **word** and **description** fields to the extracted Sutra Prayoga JSON files.

## Purpose

The enhancement script (`EnhanceJsonWithWordsAndDescriptions.py`) uses Claude's Sanskrit language models to:

1. **Extract the word**: Identify the specific Sanskrit word from the verse that each Panini sutra is explaining
2. **Extract the description**: Find the relevant portions of the commentary where the sutra is being discussed

## Input and Output

### Input Files

The script requires two input files:

1. **Extract file** (e.g., `texts/extract/kumarasambhavam_Extract.json`):
   - Contains extracted sutra references with empty `word` fields
   - Generated by `SutraPrayogaExtract.py`

2. **Source file** (e.g., `texts/In/kumarasambhavam.json`):
   - Contains the full commentary (`mn` field) for each verse
   - Used to provide context for Claude to analyze

### Output Structure

The script enhances each sutra entry from this:

```json
{
  "sutra": "2.1.49",
  "word": "",
  "sentence": "`पूर्वकालैकसर्वजरत्पुराणनवकेवलाः समानाधिकरणेन` इति समासः ।"
}
```

To this:

```json
{
  "sutra": "2.1.49",
  "word": "सर्वशैलाः",
  "sentence": "`पूर्वकालैकसर्वजरत्पुराणनवकेवलाः समानाधिकरणेन` इति समासः ।",
  "description": "सर्वे च ते शैलाश्च सर्वशैलाः । `पूर्वकालैकसर्वजरत्पुराणनवकेवलाः समानाधिकरणेन` इति समासः ।"
}
```

## How It Works

### Step 1: Load Data

The script loads:
- The extracted JSON file with sutra sentences
- The source JSON file with full commentaries
- Creates a mapping of verse locations to commentaries

### Step 2: Process Each Sutra

For each sutra reference in each verse:

1. **Prepare Context**: Gathers the sutra number, sentence, verse location, and full commentary
2. **Call Claude API**: Sends a prompt to Claude asking it to:
   - Identify the word being explained by the sutra
   - Extract the relevant description from the commentary
3. **Parse Response**: Extracts the word and description from Claude's JSON response
4. **Update Entry**: Adds the word and description to the sutra entry

### Step 3: Save Enhanced Data

The script saves the enhanced data back to the extract file with updated fields.

## Usage

### Prerequisites

1. **API Key**: Set your Anthropic API key in the environment:
   ```bash
   export ANTHROPIC_API_KEY='your-api-key-here'
   ```

2. **Files**: Ensure both the extract file and source file exist

### Running the Script

**Test on a small sample first** (recommended):

```bash
# Create a test file with just one verse
python3 -c "
import json
from pathlib import Path

extract_file = Path('texts/extract/kumarasambhavam_Extract.json')
with open(extract_file) as f:
    data = json.load(f)

test_data = data.copy()
test_data['data'] = data['data'][:1]  # Just first verse

with open('texts/extract/kumarasambhavam_Extract_test.json', 'w') as f:
    json.dump(test_data, f, ensure_ascii=False, indent=2)
"

# Run enhancement on test file
python3 scripts/EnhanceJsonWithWordsAndDescriptions.py kumarasambhavam_Extract_test.json
```

**Run on full file**:

```bash
python3 scripts/EnhanceJsonWithWordsAndDescriptions.py kumarasambhavam_Extract.json
```

**Or specify a different file**:

```bash
python3 scripts/EnhanceJsonWithWordsAndDescriptions.py <filename_Extract.json>
```

### View Example Before Running

To see what the script will do without actually calling the API:

```bash
python3 scripts/test_enhancement.py
```

This will show:
- The current state of the data
- What Claude will analyze
- What output is expected

## Implementation Details

### Claude Model

The script uses `claude-3-5-sonnet-20241022` which has excellent Sanskrit language understanding.

### Prompt Strategy

The prompt sent to Claude includes:
- Verse location for context
- Sutra number being analyzed
- The sentence containing the sutra
- Full commentary text from the `mn` field

Claude is instructed to return a JSON object with:
```json
{
  "word": "sanskrit_word_here",
  "description": "relevant_commentary_text_here"
}
```

### Error Handling

The script includes error handling for:
- Missing commentary for a verse
- API call failures
- Invalid JSON responses from Claude

If an error occurs, the script:
- Prints a warning
- Leaves the word and description fields empty
- Continues processing other sutras

## Performance Considerations

### API Costs

- Each sutra reference requires one API call to Claude
- For `kumarasambhavam_Extract.json` with 142 unique sutras, this means ~142 API calls
- Estimated cost: ~$0.10-0.20 (depending on commentary length)

### Processing Time

- Each API call takes approximately 1-3 seconds
- Total time for 142 sutras: approximately 2-7 minutes
- Progress is printed for each verse and sutra

### Rate Limiting

The script processes sutras sequentially to avoid rate limits. For larger files, you may want to add:
- Batch processing with delays
- Retry logic for failed API calls
- Checkpoint saving to resume from failures

## Validation

After running the enhancement, you can validate the results by:

1. **Checking field presence**: Ensure `word` and `description` fields exist
2. **Reviewing samples**: Manually check a few entries to ensure quality
3. **Comparing with original**: Verify that the description matches the commentary

Example validation script:

```python
import json

with open('texts/extract/kumarasambhavam_Extract.json') as f:
    data = json.load(f)

# Check first few entries
for verse in data['data'][:3]:
    print(f"\nVerse {verse['loc']}:")
    for sutra_entry in verse['sutra_sentences']:
        print(f"  Sutra {sutra_entry['sutra']}:")
        print(f"    Word: {sutra_entry['word']}")
        print(f"    Description: {sutra_entry['description'][:50]}...")
```

## Troubleshooting

### "ANTHROPIC_API_KEY environment variable not set"

Set your API key:
```bash
export ANTHROPIC_API_KEY='your-key-here'
```

### "Extract file not found"

Ensure you're running from the project root directory and the file exists:
```bash
ls texts/extract/kumarasambhavam_Extract.json
```

### "No commentary found for verse X.Y"

This means the source file doesn't have a matching verse. Check that:
- The source file is correct (same text as extract file)
- The verse numbers match between files

### API Rate Limiting

If you encounter rate limits, modify the script to add delays:
```python
import time
# Add after each API call
time.sleep(1)  # Wait 1 second between calls
```

## Future Enhancements

Potential improvements to the script:

1. **Batch Processing**: Process multiple sutras in a single API call
2. **Caching**: Cache results to avoid re-processing
3. **Parallel Processing**: Use async API calls for faster processing
4. **Validation**: Add automatic validation of extracted words against the verse
5. **Interactive Mode**: Allow manual review and correction of results

## Related Files

- `scripts/EnhanceJsonWithWordsAndDescriptions.py` - Main enhancement script
- `scripts/test_enhancement.py` - Test/demo script
- `AI_Generated/docs/EnhanceJsonFiles.md` - Original task description
- `texts/extract/kumarasambhavam_Extract.json` - File to be enhanced
- `texts/In/kumarasambhavam.json` - Source commentary file
